name: tests_cuda

on:
  workflow_dispatch:
  push:
    branches:
      - "main"
    paths:
      - "**/*.py"
      - "pyproject.toml"
      - "Makefile"
      - ".github/workflows/*.yml"
  pull_request:
    branches:
      - "main"
    paths:
      - "**/*.py"
      - "pyproject.toml"
      - "Makefile"
      - ".github/workflows/*.yml"

jobs:
  tests:
    strategy:
      fail-fast: false
      matrix:
        python:
          - "3.11"
        os:
          - "self-hosted"

    runs-on: ${{ matrix.os }}

    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}-${{ matrix.os }}-${{ matrix.python }}
      cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

    # 1. 定义全局环境变量，指向本地磁盘的持久化目录
    # 这里使用 github.workspace 的上级目录，确保 checkout 清理代码时不会删除缓存
    env:
      HF_HOME: "${{ github.workspace }}/../.runner_cache/huggingface"
      UV_CACHE_DIR: "${{ github.workspace }}/../.runner_cache/uv"
      UV_NO_SYNC: 1 # 保持你原本的设置

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ matrix.python }}
          github-token: ${{ github.token }}
          # 2. 关键点：禁用 setup-uv 自带的 GitHub Actions Cache 功能
          # 这样 uv 就会使用我们上面环境变量定义的本地路径
          enable-cache: false

      - name: Check GPU Status
        run: nvidia-smi

      - name: Install dependencies
        # uv 会自动识别 UV_CACHE_DIR 并复用本地文件
        run: |
          uv venv
          uv pip install -e ".[dev]"

      # 已删除 actions/cache 步骤

      - name: Check quality
        run: |
          make style && make quality

      - name: Check license
        run: |
          make license

      - name: Check build
        run: |
          make build

      - name: Test with pytest
        # 3. 这里不再需要动态计算 HF_HUB_OFFLINE
        # 本地硬盘有缓存 HF 就会自动用，没有就会自动下
        run: |
          make test
